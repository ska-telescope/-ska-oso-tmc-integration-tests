name: "dishleafnode-test"
function: telescope-monitoring
domain: general-monitoring
instances: ["001", "036", "063", "100"]
entrypoints:
  - name: "ska_tmc_dishleafnode.dish_leaf_node.DishLeafNode"
server:
  name: "dish_leaf_node"
  instances:
  {{- $instance_list := list -}}
  {{- $mocks_enabled := .Values.deviceServers.mocks.enabled}}
  {{- $isSimulatedDish := .Values.deviceServers.mocks.dish }}
  {{- $real_dish_name := .Values.global.namespace_dish.dish_names }}
  {{- if and (eq $mocks_enabled true) (eq $isSimulatedDish true)  }}
  {{- range $instance := .Values.global.dishes }}
  {{- $instance_list = append $instance_list ($instance) }}
  {{- end }}
  {{- else }}
  {{- range $instance_real := $real_dish_name }}
  {{- $match := (regexFind "ska(\\d{3})" $instance_real) -}}
  {{- $instance_list = append $instance_list (trimPrefix "ska" $match) }}
  {{- end }}
  {{- end }}
  {{- range $index, $number := $instance_list }}
    - name: "{{ $number }}"
      classes:
      - name: "DishLeafNode"
        devices:
        - name: "ska_mid/tm_leaf_node/d0{{ $number }}"
          properties:
          - name: "DishMasterFQDN"
            values:
              {{- if and (eq $mocks_enabled true) (eq $isSimulatedDish true)  }}
              - "ska{{ printf $number }}/elt/master" # Mock device FQDN
              {{- else }}
              {{- range $index_real, $instance_real := $real_dish_name }}
              {{- if eq $index_real $index }}
              - "{{ $instance_real }}"
              {{- end }}
              {{- end }}
              {{- end }}
          - name: "SkaLevel"
            values:
              - "3"
          - name: "LoggingTargetsDefault"
            values:
              - "tango::logger"
          - name: "LoggingLevelDefault"
            values:
              - "5"
          - name: "CommandTimeOut"
            values:
              - "50"
          - name: "polled_attr"
            values:
              - "kValue"
              - "3000"
              - "kValueValidationResult"
              - "3000"
  {{- end }}
depends_on:
  - device: sys/database/2
image:
  registry: "{{.Values.dishleafnode.image.registry}}"
  image: "{{.Values.dishleafnode.image.image}}"
  tag: "{{.Values.dishleafnode.image.tag}}"
  pullPolicy: "{{.Values.dishleafnode.image.pullPolicy}}"