name: "centralnode-test"
function: telescope-monitoring
domain: general-monitoring
instances: ["01"]
{{- $DishMasterPrefix := .Values.deviceServers.centralnode.DishMasterPrefix }}
{{- $DishMasterPostfix := .Values.deviceServers.centralnode.DishMasterPostfix }}
{{- $RealDishMasterTag := .Values.deviceServers.centralnode.RealDishMasterTag }}
{{- $SimulatorDishMasterTag := .Values.deviceServers.centralnode.SimulatorDishMasterTag }}
entrypoints:
  - name: "ska_tmc_centralnode.central_node_mid.CentralNodeMid"
server:
  name: "central_node_mid"
  instances:
  {{- $tmc_sa_fqdn_prefix:= .Values.global.tmc_subarray_prefix}}
  {{- $csp_sa_ln_fqdn_prefix:= .Values.global.csp_subarray_ln_prefix}}
  {{- $sdp_sa_ln_fqdn_prefix:= .Values.global.sdp_subarray_ln_prefix}}
  {{- $isSimulatedDish := .Values.deviceServers.mocks.dish }}
  {{- $real_dish_name := .Values.global.namespace_dish.dish_names }}
  {{- $DishMasterPrefix := .Values.deviceServers.centralnode.DishMasterPrefix }}
  {{- $DishMasterPostfix := .Values.deviceServers.centralnode.DishMasterPostfix }}
  {{- $RealDishMasterTag := .Values.deviceServers.centralnode.RealDishMasterTag }}
  {{- $SimulatorDishMasterTag := .Values.deviceServers.centralnode.SimulatorDishMasterTag }}
  {{- $isSimulatedCsp := .Values.deviceServers.mocks.csp }}
  {{- $mocks_enabled := .Values.deviceServers.mocks.enabled}}
  - name: "01"
    classes:
    - name: "CentralNodeMid"
      devices:
      - name: "ska_mid/tm_central/central_node"
        properties:
        - name: "CspMasterLeafNodeFQDN"
          values:
          - "{{.Values.global.csp_master_ln_prefix}}"
        - name: "CspMasterFQDN"
          values:
          - "{{.Values.global.csp_master}}"
        - name: "SdpMasterLeafNodeFQDN"
          values:
          - "{{.Values.global.sdp_master_ln_prefix}}"
        - name: "SdpMasterFQDN"
          values:
          - "{{.Values.global.sdp_master}}"
        - name: "DishLeafNodePrefix"
          values:
          - "ska_mid/tm_leaf_node/d0"
        - name: "DishMasterTag"
          values:
          {{- if and (eq $mocks_enabled true) (eq $isSimulatedDish true) }}
          - "{{ $SimulatorDishMasterTag }}"
          {{- else }}
          - "{{ $RealDishMasterTag }}" # Real dish
          {{- end }}
        - name: "DishVccUri"
          values:
          - "{{.Values.deviceServers.centralnode.DishVccConfig.DishVccUri}}"
        - name: "DishVccFilePath"
          values:
          - "{{.Values.deviceServers.centralnode.DishVccConfig.DishVccFilePath}}"
        - name: "EnableDishVccInit"
          values:
          - "{{.Values.deviceServers.centralnode.DishVccConfig.Enabled}}"
        - name: "DishKvalueAggregationAllowedPercent"
          values:
          - "{{.Values.deviceServers.centralnode.DishVccConfig.DishKvalueAggregationAllowedPercent}}"
        - name: "DishIDs"
          values:
          {{- range  (.Values.deviceServers.centralnode.DishIDs)  }}
          - "{{ . }}"
          {{- end }}
        - name: "DishMasterFQDN"
          values:
          {{- if and (eq $mocks_enabled true) (eq $isSimulatedDish true) }}
          {{- range  (.Values.deviceServers.centralnode.DishIDs)  }}
          - "{{ . | lower }}/{{ $SimulatorDishMasterTag }}"
          {{- end }}
          {{- else }}
          {{- range  (.Values.global.namespace_dish.dish_names)  }}
          - "{{ . }}" # Real dish
          {{- end }}
          {{- end }}
        - name: "TMCSubarrayNodes"
          values:
          {{- range  ( regexSplit " " ((.Values.subarray_count | int) | seq ) -1 )  }}
          - "{{ $tmc_sa_fqdn_prefix }}/{{ . }}"
          {{- end }}
        - name: "CspSubarrayLeafNodes"
          values:
          {{- range  ( regexSplit " " ((.Values.subarray_count | int) | seq ) -1 )  }}
          - "{{ $csp_sa_ln_fqdn_prefix }}{{ printf "%02s" . }}"
          {{- end }}
        - name: "SdpSubarrayLeafNodes"
          values:
          {{- range  ( regexSplit " " ((.Values.subarray_count | int) | seq ) -1 )  }}
          - "{{ $sdp_sa_ln_fqdn_prefix }}{{ printf "%02s" . }}"
          {{- end }}
        - name: "SkaLevel"
          values:
            - "1"
        - name: "LoggingTargetsDefault"
          values:
            - "tango::logger"
        - name: "LoggingLevelDefault"
          values:
            - "5"
        - name: "DishVccInitTimeout"
          values:
            - "180" 
        - name: "polled_attr"
          values:
            - "isDishVccConfigSet"
            - "3000"
            - "DishVccValidationStatus"
            - "3000"
depends_on:
  - device: sys/database/2
image:
  registry: "{{.Values.centralnode.image.registry}}"
  image: "{{.Values.centralnode.image.image}}"
  tag: "{{.Values.centralnode.image.tag}}"
  pullPolicy: "{{.Values.centralnode.image.pullPolicy}}"

