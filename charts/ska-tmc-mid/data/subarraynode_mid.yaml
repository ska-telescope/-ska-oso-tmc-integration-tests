name: "subarraynode-test"
function: telescope-monitoring
domain: subarray
instances: ["01"]
entrypoints:
  - name: "ska_tmc_subarraynode.subarray_node_mid.SubarrayNodeMid"
server:
  name: "subarray_node_mid"
  instances:
  {{- $csp_sa_ln_fqdn_prefix:= .Values.global.csp_subarray_ln_prefix}}
  {{- $sdp_sa_ln_fqdn_prefix:= .Values.global.sdp_subarray_ln_prefix}}
  {{- $csp_sa_fqdn_prefix:= .Values.global.csp_subarray_prefix}}
  {{- $sdp_sa_fqdn_prefix:= .Values.global.sdp_subarray_prefix}}
  {{- $isSimulatedDish := .Values.deviceServers.mocks.dish }}
  {{- $real_dish_name := .Values.global.namespace_dish.dish_names }}
  {{- $DishMasterPrefix := .Values.deviceServers.subarraynode.DishMasterPrefix }}
  {{- $DishMasterPostfix := .Values.deviceServers.subarraynode.DishMasterPostfix }}
  {{- $RealDishMasterTag := .Values.deviceServers.centralnode.RealDishMasterTag }}
  {{- $SimulatorDishMasterTag := .Values.deviceServers.centralnode.SimulatorDishMasterTag }}
  {{- $dish_id := .Values.deviceServers.subarraynode.DishIDs }}
  {{- $mocks_enabled := .Values.deviceServers.mocks.enabled}}
  {{- range  ( regexSplit " " ((.Values.subarray_count | int) | seq ) -1 ) }}
    - name: "{{ printf "%02s" . }}"
      classes:
      - name: "SubarrayNodeMid"
        devices:
        - name: "ska_mid/tm_subarray_node/{{ . }}"
          properties:
          - name: "DishLeafNodePrefix"
            values:
            - "ska_mid/tm_leaf_node/d0"
          - name: "DishMasterPrefix"
            values:
            - "{{ $DishMasterPrefix }}"
          - name: "DishMasterTag"
            values:
            {{- if and (eq $mocks_enabled true) (eq $isSimulatedDish true) }}
            - "{{ $SimulatorDishMasterTag }}"
            {{- else }}
            - "{{ $RealDishMasterTag }}" # Real dish
            {{- end }}
          - name: "DishMasterPostfix"
            values:
            - "{{ $DishMasterPostfix }}"
          - name: "CspSubarrayLNFQDN"
            values:
            - "{{ $csp_sa_ln_fqdn_prefix}}{{ printf "%02s" . }}"
          - name: "SdpSubarrayLNFQDN"
            values:
            - "{{ $sdp_sa_ln_fqdn_prefix}}{{ printf "%02s" . }}"
          - name: "CspSubarrayFQDN"
            values:
            - "{{ $csp_sa_fqdn_prefix}}/{{ printf "%02s" . }}"
          - name: "SdpSubarrayFQDN"
            values:
            - "{{ $sdp_sa_fqdn_prefix}}/{{ printf "%02s" . }}"
          - name: "DishIDs"
            values:
            {{- range  $dish_id  }}
            - "{{ . }}"
            {{- end }}
          - name: "DishMasterFQDN"
            values:
            {{- if and (eq $mocks_enabled true) (eq $isSimulatedDish true) }}
            {{- range  $dish_id }}
            - "{{ . | lower }}/{{ $SimulatorDishMasterTag }}"
            {{- end }}
            {{- else }}
            {{- range  $real_dish_name }}
            - "{{ . }}" # Real dish
            {{- end }}
            {{- end }}
          - name: "SkaLevel"
            values:
              - "2"
          - name: "LoggingTargetsDefault"
            values:
              - "tango::logger"
          - name: "LoggingLevelDefault"
            values:
              - "5"
          - name: "CommandTimeOut"
            values:
              - "60"
          - name: "AbortCommandTimeout"
            values:
              - "100"
  {{- end}}
depends_on:
  - device: sys/database/2
image:
  registry: "{{.Values.subarraynode.image.registry}}"
  image: "{{.Values.subarraynode.image.image}}"
  tag: "{{.Values.subarraynode.image.tag}}"
  pullPolicy: "{{.Values.subarraynode.image.pullPolicy}}"

