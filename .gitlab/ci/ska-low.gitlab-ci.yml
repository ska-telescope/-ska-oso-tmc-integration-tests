k8s-test-low:
  # allow_failure: true
  image: $SKA_K8S_TOOLS_BUILD_DEPLOY
  stage: test
  tags:
    - k8srunner
  variables:
    CONFIG: low
    KUBE_NAMESPACE: 'ci-$CI_PROJECT_NAME-$CI_COMMIT_SHORT_SHA-$CONFIG'
    TELESCOPE: SKA-low
    MARK: SKA_low
    K8S_CHART_DEPLOYMENT: ska-tmc-low
  before_script:
    - '[ -f .make/k8s.mk ] || (echo "File k8s.mk not included in Makefile; exit 1")'
    - 'make help | grep k8s-test'
    - make k8s-install-chart 
    - make k8s-wait 
  script:
    - make k8s-test 
  artifacts:
    name: "$CI_PROJECT_NAME-$CI_JOB_ID"
    paths:
      - "build/"
    reports:
      junit: build/report.xml
    when: always
  environment:
    name: test/$CI_COMMIT_REF_SLUG
    on_stop: stop-k8s-test-low
    auto_stop_in: 1 minute
  rules:
    - exists:
        - tests/**/*

stop-k8s-test-low:
  image: $SKA_K8S_TOOLS_BUILD_DEPLOY
  stage: test
  tags:
    - k8srunner
  when: manual
  variables:
    CONFIG: low
    TELESCOPE: SKA-low
    KUBE_NAMESPACE: 'ci-$CI_PROJECT_NAME-$CI_COMMIT_SHORT_SHA-$CONFIG'
  script:
    - make k8s-uninstall-chart 
    - kubectl -n $KUBE_NAMESPACE delete pods,svc,daemonsets,deployments,replicasets,statefulsets,cronjobs,jobs,ingresses,configmaps --all
    - make k8s-delete-namespace 
  environment:
    name: test/$CI_COMMIT_REF_SLUG
    action: stop

